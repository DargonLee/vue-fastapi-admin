var q=($,p,n)=>new Promise((b,v)=>{var U=d=>{try{y(n.next(d))}catch(r){v(r)}},k=d=>{try{y(n.throw(d))}catch(r){v(r)}},y=d=>d.done?b(d.value):Promise.resolve(d.value).then(U,k);y((n=n.apply($,p)).next())});import{x,X as K,a8 as g,Y as O,Z as c,_,$ as i,a6 as w,a2 as e,A as N,a1 as s,a7 as T,a9 as P,an as M,aN as V,a4 as j,M as G,a5 as X,h as o,aa as A,aO as Y,ab as z,V as H}from"./index-1319d715.js";import{_ as J}from"./CommonPage-1b7131ea.js";import{_ as D}from"./QueryBarItem-8c7c36d3.js";import{u as Q,_ as W,N as ee}from"./useCRUD-32249973.js";import{a as ae,_ as le,e as te,N as re,d as se}from"./CrudTable-1b72018f.js";import{N as h}from"./Input-80da2416.js";import{N as ie,a as m}from"./FormItem-a3720c19.js";import{N as S}from"./Switch-210aff7b.js";import{N as ue}from"./Image-9de67d83.js";import"./AppPage-2c648aa5.js";const ye=Object.assign({name:"用户管理"},{__name:"index",setup($){const p=x(null),n=x({}),b=K("permission"),{modalVisible:v,modalTitle:U,modalAction:k,modalLoading:y,handleSave:d,modalForm:r,modalFormRef:F,handleEdit:I,handleDelete:B,handleAdd:R}=Q({name:"用户",initForm:{},doCreate:g.createUser,doUpdate:g.updateUser,doDelete:g.deleteUser,refresh:()=>{var a;return(a=p.value)==null?void 0:a.handleSearch()}}),C=x([]);O(()=>{var a;(a=p.value)==null||a.handleSearch(),g.getRoleList({page:1,page_size:9999}).then(t=>C.value=t.data)});const L=[{title:"头像",key:"avatar",width:50,align:"center",render(a){return o(ue,{height:50,imgProps:{style:{"border-radius":"3px"}},src:a.avatar,"fallback-src":"http://dummyimage.com/400x400","show-toolbar-tooltip":!0})}},{title:"名称",key:"username",width:60,align:"center",ellipsis:{tooltip:!0}},{title:"邮箱",key:"email",width:60,align:"center",ellipsis:{tooltip:!0}},{title:"用户角色",key:"role",width:60,align:"center",render(a){var u;const t=(u=a.roles)!=null?u:[],l=[];for(let f=0;f<t.length;f++)l.push(o(A,{type:"info",style:{margin:"2px 3px"}},{default:()=>t[f].name}));return o("span",l)}},{title:"超级用户",key:"is_superuser",align:"center",width:40,render(a){return o(A,{type:"info",style:{margin:"2px 3px"}},{default:()=>a.is_superuser?"是":"否"})}},{title:"上次登录时间",key:"last_login",align:"center",width:80,ellipsis:{tooltip:!0},render(a){return o(N,{size:"small",type:"text",ghost:!0},{default:()=>a.last_login!==null?Y(a.last_login):null,icon:z("mdi:update",{size:16})})}},{title:"禁用",key:"is_active",width:50,align:"center",render(a){return o(S,{size:"small",rubberBand:!1,value:a.is_active,loading:!!a.publishing,checkedValue:!1,uncheckedValue:!0,onUpdateValue:()=>Z(a)})}},{title:"操作",key:"actions",width:80,align:"center",fixed:"right",render(a){return[w(o(N,{size:"small",type:"primary",style:"margin-right: 8px;",onClick:()=>{I(a),r.value.roles=a.roles.map(t=>t=t.id)}},{default:()=>"编辑",icon:z("material-symbols:edit",{size:16})}),[[b,"post/api/v1/user/update"]]),o(ee,{onPositiveClick:()=>B({user_id:a.id},!1),onNegativeClick:()=>{}},{trigger:()=>w(o(N,{size:"small",type:"error"},{default:()=>"删除",icon:z("material-symbols:delete-outline",{size:16})}),[[b,"delete/api/v1/user/delete"]]),default:()=>o("div",{},"确定删除该用户吗?")})]}}];function Z(a){return q(this,null,function*(){var u;if(!a.id)return;if(H().userId===a.id){$message.error("当前登录用户不可禁用！");return}a.publishing=!0,a.is_active=a.is_active===!1,a.publishing=!1;const l=[];a.roles.forEach(f=>{l.push(f.id)}),a.roles=l;try{yield g.updateUser(a),$message==null||$message.success(a.is_active?"已取消禁用该用户":"已禁用该用户"),(u=p.value)==null||u.handleSearch()}catch(f){a.is_active=a.is_active===!1}finally{a.publishing=!1}})}const E={username:[{required:!0,message:"请输入名称",trigger:["input","blur"]}],email:[{required:!0,message:"请输入邮箱地址",trigger:["input","change"]},{trigger:["blur"],validator:(a,t,l)=>{if(!/^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/.test(r.value.email)){l("邮箱格式错误");return}l()}}],password:[{required:!0,message:"请输入密码",trigger:["input","blur","change"]}],confirmPassword:[{required:!0,message:"请再次输入密码",trigger:["input"]},{trigger:["blur"],validator:(a,t,l)=>{if(t!==r.value.password){l("两次密码输入不一致");return}l()}}],roles:[{type:"array",required:!0,message:"请至少选择一个角色",trigger:["blur","change"]}]};return(a,t)=>(c(),_(J,{"show-footer":"",title:"用户列表"},{action:i(()=>[w((c(),_(e(N),{type:"primary",onClick:e(R)},{default:i(()=>[s(ae,{icon:"material-symbols:add",size:18,class:"mr-5"}),T("新建用户 ")]),_:1},8,["onClick"])),[[e(b),"post/api/v1/user/create"]])]),default:i(()=>[s(le,{ref_key:"$table",ref:p,"query-items":n.value,"onUpdate:queryItems":t[4]||(t[4]=l=>n.value=l),columns:L,"get-data":e(g).getUserList},{queryBar:i(()=>[s(D,{label:"名称","label-width":40},{default:i(()=>[s(e(h),{value:n.value.username,"onUpdate:value":t[0]||(t[0]=l=>n.value.username=l),clearable:"",type:"text",placeholder:"请输入用户名称",onKeypress:t[1]||(t[1]=P(l=>{var u;return(u=p.value)==null?void 0:u.handleSearch()},["enter"]))},null,8,["value"])]),_:1}),s(D,{label:"邮箱","label-width":40},{default:i(()=>[s(e(h),{value:n.value.email,"onUpdate:value":t[2]||(t[2]=l=>n.value.email=l),clearable:"",type:"text",placeholder:"请输入邮箱",onKeypress:t[3]||(t[3]=P(l=>{var u;return(u=p.value)==null?void 0:u.handleSearch()},["enter"]))},null,8,["value"])]),_:1})]),_:1},8,["query-items","get-data"]),s(W,{visible:e(v),"onUpdate:visible":t[12]||(t[12]=l=>M(v)?v.value=l:null),title:e(U),loading:e(y),onSave:e(d)},{default:i(()=>[s(e(ie),{ref_key:"modalFormRef",ref:F,"label-placement":"left","label-align":"left","label-width":80,model:e(r),rules:E},{default:i(()=>[s(e(m),{label:"用户名称",path:"username"},{default:i(()=>[s(e(h),{value:e(r).username,"onUpdate:value":t[5]||(t[5]=l=>e(r).username=l),clearable:"",placeholder:"请输入用户名称"},null,8,["value"])]),_:1}),s(e(m),{label:"邮箱",path:"email"},{default:i(()=>[s(e(h),{value:e(r).email,"onUpdate:value":t[6]||(t[6]=l=>e(r).email=l),clearable:"",placeholder:"请输入邮箱"},null,8,["value"])]),_:1}),e(k)==="add"?(c(),_(e(m),{key:0,label:"密码",path:"password"},{default:i(()=>[s(e(h),{value:e(r).password,"onUpdate:value":t[7]||(t[7]=l=>e(r).password=l),"show-password-on":"mousedown",type:"password",clearable:"",placeholder:"请输入密码"},null,8,["value"])]),_:1})):V("",!0),e(k)==="add"?(c(),_(e(m),{key:1,label:"确认密码",path:"confirmPassword"},{default:i(()=>[s(e(h),{value:e(r).confirmPassword,"onUpdate:value":t[8]||(t[8]=l=>e(r).confirmPassword=l),"show-password-on":"mousedown",type:"password",clearable:"",placeholder:"请确认密码"},null,8,["value"])]),_:1})):V("",!0),s(e(m),{label:"角色",path:"roles"},{default:i(()=>[s(e(te),{value:e(r).roles,"onUpdate:value":t[9]||(t[9]=l=>e(r).roles=l)},{default:i(()=>[s(e(re),{"item-style":"display: flex;"},{default:i(()=>[(c(!0),j(G,null,X(C.value,l=>(c(),_(e(se),{key:l.id,value:l.id,label:l.name},null,8,["value","label"]))),128))]),_:1})]),_:1},8,["value"])]),_:1}),s(e(m),{label:"超级用户",path:"is_superuser"},{default:i(()=>[s(e(S),{value:e(r).is_superuser,"onUpdate:value":t[10]||(t[10]=l=>e(r).is_superuser=l),size:"small","checked-value":!0,"unchecked-value":!1},null,8,["value"])]),_:1}),s(e(m),{label:"禁用",path:"is_active"},{default:i(()=>[s(e(S),{value:e(r).is_active,"onUpdate:value":t[11]||(t[11]=l=>e(r).is_active=l),"checked-value":!1,"unchecked-value":!0,"default-value":!0},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["visible","title","loading","onSave"])]),_:1}))}});export{ye as default};
